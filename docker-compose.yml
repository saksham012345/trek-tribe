services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    ports:
      - '27017:27017'
    volumes:
      - mongo_data:/data/db
      
  api:
    build: ./services/api
    restart: unless-stopped
    environment:
      - MONGODB_URI=mongodb://mongo:27017/trektribe
      - NODE_ENV=development
      - PORT=4000
      # Provide a secure default for local/dev runs (must be >= 32 chars)
      - JWT_SECRET=a2f4b6c8d0e2f6a8b0c2d4e6f8a0b2c4d6e8f0a2b4c6d8e0f2a4b6c8d0e2f6
    ports:
      - '4000:4000'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - mongo
      
  web:
    build: ./web
    restart: unless-stopped
    ports:
      - '3000:80'
    depends_on:
      - api

  ai-service:
    build: ./ai-service
    restart: unless-stopped
    environment:
      - PORT=8000
      - AI_SERVICE_KEY=5YDVAJioLzl0wq0u1r4X9na6ypPkZpiQeEUynHaDMo0=
      - REQUIRE_API_KEY=true
      - MODEL_LOCAL_ENABLED=true
      - MODEL_NAME=google/flan-t5-base
      - MODEL_DIR=/app/models/google_flan-t5-base
      - MODEL_INSTRUCTION_TUNED=true
      - DATA_DIR=/app/data
      - MAX_GENERATION_TOKENS=256
      - AI_GEN_TIMEOUT=50
      - AI_MAX_INPUT_TOKENS=800
      - AI_RATE_LIMIT=20
      - AI_RATE_WINDOW=60
      - CORS_ORIGINS=http://localhost:3000,http://localhost:4000
      - LOG_LEVEL=INFO
    ports:
      - '8000:8000'
    volumes:
      - ./ai-service/data:/app/data:rw
      - ./ai-service/models:/app/models:rw
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - api
      
volumes:
  mongo_data:

