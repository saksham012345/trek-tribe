# Deployment Fix Guide

## Issues Fixed

### 1. Backend API TypeScript Errors
- **Issue**: Zod schema remnants causing compilation errors in `marketplace.ts`
- **Fix**: Removed duplicate Zod schema definitions, kept custom validation schema
- **Status**: ✅ Fixed

### 2. Docker Build Issues
- **Issue**: `npm ci` failing due to lockfile mismatch
- **Fix**: Changed Dockerfile to use `npm install` instead of `npm ci` for flexibility
- **Status**: ✅ Fixed

### 3. Missing Environment Variables
- **Issue**: Deployment configs missing critical env vars for AI service integration
- **Fix**: Added complete env var configs to all render.yaml files
- **Status**: ✅ Fixed

## Deployment Configuration

### Root `render.yaml` (Multi-Service)
Deploys all three services together:
- **trek-tribe-api**: Backend Node.js service
- **trek-tribe-ai-service**: Python FastAPI AI service (Docker)
- **trek-tribe-web**: React frontend (static site)

### Individual Service Configs
- `services/api/render.yaml`: Backend-only deployment
- `ai-service/render.yaml`: AI service-only deployment
- `web/render.yaml`: Frontend-only deployment

## Environment Variables Required

### Backend API (`trek-tribe-api`)
```bash
NODE_ENV=production
PORT=10000
JWT_SECRET=<auto-generated>
MONGODB_URI=<your-mongodb-uri>
FRONTEND_URL=https://trek-tribe-web.onrender.com
CORS_ORIGIN=https://trek-tribe-web.onrender.com
AI_SERVICE_URL=https://trek-tribe-ai-service.onrender.com
AI_SERVICE_KEY=<match-ai-service-key>
RAZORPAY_KEY_ID=<your-razorpay-key>
RAZORPAY_KEY_SECRET=<your-razorpay-secret>
REDIS_URL=<optional-redis-url>
GMAIL_USER=<your-gmail>
GMAIL_APP_PASSWORD=<your-gmail-app-password>
```

### AI Service (`trek-tribe-ai-service`)
```bash
PORT=8000
CORS_ORIGINS=https://trek-tribe-web.onrender.com,https://trek-tribe-api.onrender.com
API_KEY=<auto-generated-match-backend>
REQUIRE_API_KEY=true
MODEL_NAME=google/flan-t5-base
MODEL_LOCAL_ENABLED=true
REDIS_URL=<optional-redis-url>
LOG_LEVEL=INFO
```

### Frontend (`trek-tribe-web`)
```bash
REACT_APP_API_URL=https://trek-tribe-api.onrender.com
REACT_APP_AI_SERVICE_URL=https://trek-tribe-ai-service.onrender.com
REACT_APP_APP_NAME=Trek Tribe
REACT_APP_VERSION=1.0.0
NODE_ENV=production
```

## Deployment Steps

### Option 1: Deploy All Services (Recommended)
1. Push changes to GitHub
2. In Render dashboard, create a new Blueprint
3. Connect to your repo
4. Select `render.yaml` in root directory
5. Render will create all three services automatically
6. Set environment variables marked with `sync: false`

### Option 2: Deploy Services Individually
1. **Deploy AI Service First**:
   - Create new Web Service in Render
   - Environment: Docker
   - Root Directory: `ai-service`
   - Use `ai-service/render.yaml` or manual config
   - Set all required env vars

2. **Deploy Backend API**:
   - Create new Web Service in Render
   - Environment: Node
   - Root Directory: `services/api`
   - Use `services/api/render.yaml` or manual config
   - Set `AI_SERVICE_URL` to the AI service URL from step 1
   - Ensure `AI_SERVICE_KEY` matches the key from AI service

3. **Deploy Frontend**:
   - Create new Static Site in Render
   - Root Directory: `web`
   - Set `REACT_APP_API_URL` to backend URL from step 2
   - Set `REACT_APP_AI_SERVICE_URL` to AI service URL from step 1

## Post-Deployment Verification

### 1. Check Health Endpoints
```bash
# Backend API
curl https://trek-tribe-api.onrender.com/health

# AI Service
curl https://trek-tribe-ai-service.onrender.com/health

# Frontend
curl https://trek-tribe-web.onrender.com
```

### 2. Test AI Integration
```bash
# From backend to AI service
curl -X POST https://trek-tribe-api.onrender.com/api/ai/chat \
  -H "Authorization: Bearer <your-jwt>" \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello"}'
```

### 3. Verify CORS
- Open browser console on frontend
- Make API requests
- Should not see CORS errors

## Common Issues & Solutions

### Issue: AI Service Taking Long to Start
**Cause**: Model downloading on first boot  
**Solution**: Wait 5-10 minutes for initial deployment; subsequent restarts are faster

### Issue: Backend Cannot Connect to AI Service
**Cause**: Wrong API key or URL  
**Solution**: 
- Verify `AI_SERVICE_URL` in backend env
- Ensure `AI_SERVICE_KEY` matches between services
- Check AI service logs for authentication errors

### Issue: npm Install Fails
**Cause**: Lockfile mismatch or missing dependencies  
**Solution**: 
- Dockerfiles now use `npm install` (more forgiving)
- For local builds, run `npm install` to regenerate lockfile
- Commit updated `package-lock.json`

### Issue: TypeScript Build Errors
**Cause**: Type mismatches or missing dependencies  
**Solution**: 
- All current TypeScript errors are fixed
- Check build logs for specific errors
- Ensure all `@types/*` packages are installed

## Environment Variable Priority

1. Render dashboard (highest)
2. render.yaml file
3. .env files (ignored in deployment)
4. Code defaults (lowest)

## Security Checklist
- ✅ JWT_SECRET is auto-generated
- ✅ API_KEY is auto-generated
- ✅ Sensitive vars use `sync: false`
- ✅ CORS origins are restricted
- ✅ HTTPS enforced
- ✅ Helmet security headers enabled
- ✅ Rate limiting configured

## Monitoring
- Check Render logs for each service
- Monitor memory/CPU usage in Render dashboard
- Set up alerts for service failures
- Monitor AI service response times

## Rollback Plan
1. In Render dashboard, go to service
2. Click "Deploys" tab
3. Find previous successful deploy
4. Click "Redeploy"

## Next Steps After Deployment
1. Test all critical flows (auth, trips, payments)
2. Monitor error rates and performance
3. Set up custom domain (optional)
4. Configure CDN for static assets (optional)
5. Set up automated backups for MongoDB

---
**Last Updated**: December 13, 2025  
**Status**: ✅ Ready for Deployment
